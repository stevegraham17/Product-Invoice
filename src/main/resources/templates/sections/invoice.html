<!-- Invoice Section-specific styles -->
<style>
    .invoice-form-section {
        background: white;
        border-radius: var(--border-radius);
        padding: 25px;
        box-shadow: var(--box-shadow);
        margin-bottom: 25px;
    }

    .scanner-section {
        background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
        border-radius: var(--border-radius);
        padding: 20px;
        color: white;
        margin-bottom: 25px;
    }

    .scanner-title {
        color: white;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .scanner-controls {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .scanner-input {
        flex: 1;
        min-width: 200px;
    }

    .scanner-status {
        margin-top: 10px;
        font-size: 14px;
        opacity: 0.9;
    }

    .product-search-container {
        position: relative;
    }

    .suggestions-box {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        z-index: 1000;
        max-height: 250px;
        overflow-y: auto;
        display: none;
    }

    .suggestion-item {
        padding: 12px 15px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: var(--transition);
    }

    .suggestion-item:hover {
        background: rgba(67, 97, 238, 0.08);
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .selected-products-table {
        margin-top: 25px;
    }

    .remove-btn {
        background: var(--danger-color);
        color: white;
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        font-size: 12px;
        transition: var(--transition);
    }

    .remove-btn:hover {
        background: #e11574;
        transform: scale(1.05);
    }

    .totals-section {
        background: white;
        border-radius: var(--border-radius);
        padding: 20px;
        box-shadow: var(--box-shadow);
        margin-top: 25px;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }

    .total-row:last-child {
        border-bottom: none;
        font-weight: 700;
        font-size: 18px;
        color: var(--primary-color);
    }

    /* View Mode Styles */
    .view-mode .form-control:not([readonly]),
    .view-mode .form-select,
    .view-mode .form-check-input,
    .view-mode #addProductBtn,
    .view-mode .remove-product-btn,
    .view-mode .action-button[type="submit"] {
        pointer-events: none;
        opacity: 0.7;
        background-color: #f8f9fa;
    }

    .view-mode .action-button[type="submit"]::after {
        content: " (View Mode)";
        font-size: 0.8em;
        opacity: 0.8;
    }

    .view-mode-alert {
        margin-bottom: 20px;
    }

    .edit-invoice-btn {
        margin-left: 10px;
    }
</style>

<!-- Invoice Content -->
<div class="page-header">
    <div>
        <h1 class="page-title">Create New Invoice</h1>
        <p class="page-subtitle">Generate professional invoices for your customers</p>
    </div>
    <button class="action-button" onclick="window.location.href='/billing?section=products'">
        <span class="material-symbols-outlined">inventory_2</span>
        View Products
    </button>
</div>

<!-- View Mode Alert (will be shown when viewing existing invoice) -->
<div id="viewModeAlert" class="alert alert-info view-mode-alert" style="display: none;">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <strong>ðŸ“‹ View Mode:</strong> You are viewing an existing invoice. 
            <span id="viewedInvoiceId" class="badge bg-primary ms-2"></span>
        </div>
        <button type="button" class="btn btn-outline-primary btn-sm edit-invoice-btn" onclick="exitViewMode()">
            <span class="material-symbols-outlined" style="font-size: 16px;">edit</span>
            Edit Invoice
        </button>
    </div>
</div>

<div class="scanner-section">
    <h5 class="scanner-title">
        <span class="material-symbols-outlined">qr_code_scanner</span>
        Barcode Scanner
    </h5>
    <div class="scanner-controls">
        <input type="text" id="barcodeInput" class="form-control scanner-input" placeholder="Enter barcode or click to scan" autocomplete="off">
        <button id="startScannerBtn" class="btn btn-light">Start Scanner</button>
        <button id="stopScannerBtn" class="btn btn-outline-light" disabled>Stop Scanner</button>
    </div>
    <div class="scanner-status" id="scannerStatus">Scanner not active</div>
</div>

<form action="/billing" method="post" id="billingForm">
    <div class="row g-4">
        <!-- Customer Details -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <span class="material-symbols-outlined">person</span>
                        Customer Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="invoiceId" class="form-label">Invoice ID</label>
                        <input type="text" class="form-control" id="invoiceId" name="invoiceId" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="customerPhone" class="form-label">Customer Phone No.</label>
                        <input type="tel" class="form-control" id="customerPhone" name="customerPhone" required placeholder="Enter phone number">
                    </div>
                    <div class="mb-3">
                        <label for="customerName" class="form-label">Customer Name</label>
                        <input type="text" class="form-control" id="customerName" name="customerName" required placeholder="Enter customer name">
                    </div>
                    <div class="mb-3">
                        <label for="customerGstin" class="form-label">GST Number</label>
                        <input type="text" class="form-control" id="customerGstin" name="customerGstin" placeholder="Enter GST number">
                    </div>
                    <div class="mb-3">
                        <label for="orderType" class="form-label">Order Type</label>
                        <select class="form-select" id="orderType" name="orderType" required>
                            <option value="sales">Sales</option>
                            <option value="purchase">Purchase</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- B2B Fields -->
            <div id="b2bFields" class="card mt-4" style="display:none;">
                <div class="card-header">
                    <h5 class="card-title">
                        <span class="material-symbols-outlined">business_center</span>
                        B2B Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="transportMode" class="form-label">Transport Mode</label>
                        <input type="text" class="form-control" id="transportMode" name="transportMode">
                    </div>
                    <div class="mb-3">
                        <label for="vehicleNumber" class="form-label">Vehicle Number</label>
                        <input type="text" class="form-control" id="vehicleNumber" name="vehicleNumber">
                    </div>
                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="reverseCharge" name="reverseCharge" value="true">
                        <label class="form-check-label" for="reverseCharge">Reverse Charge</label>
                    </div>
                    <div class="mb-3">
                        <label for="supplyDate" class="form-label">Supply Date</label>
                        <input type="date" class="form-control" id="supplyDate" name="supplyDate">
                    </div>
                    <div class="mb-3">
                        <label for="dueDate" class="form-label">Due Date</label>
                        <input type="date" class="form-control" id="dueDate" name="dueDate">
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Selection & Calculation -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title">
                        <span class="material-symbols-outlined">shopping_cart</span>
                        Product Selection
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3 product-search-container">
                        <label for="product-search" class="form-label">Search Product</label>
                        <input type="text" id="product-search" class="form-control" placeholder="Search product by name...">
                        <input type="hidden" id="id_product" name="product">
                        <div id="suggestion-box" class="suggestions-box"></div>
                    </div>

                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="productQuantity" class="form-label">Quantity</label>
                            <input type="number" id="productQuantity" class="form-control" min="1" value="1">
                        </div>
                        <div class="col-md-6">
                            <label for="sum" class="form-label">Subtotal</label>
                            <input type="text" class="form-control" id="sum" name="sum" readonly value="0.00">
                        </div>
                    </div>

                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label for="tax" class="form-label">Tax Percentage</label>
                            <select id="tax" class="form-select" name="tax" required>
                                <option value="18">India(IGst) - 18%</option>
                                <option value="9">India(CGST) - 9%</option>
                                <option value="9">India(SGST) - 9%</option>
                                <option value="0">No Tax</option>
                                <option value="10">Other Country - 10%</option>
                                <option value="15">Other Country - 15%</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="taxAmount" class="form-label">Tax Amount</label>
                            <input type="text" class="form-control" id="taxAmount" name="taxAmount" readonly value="0.00">
                        </div>
                        <div class="col-md-6">
                            <label for="totalPrice" class="form-label">Total Price</label>
                            <input type="text" class="form-control" id="totalPrice" name="totalPrice" readonly value="0.00">
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="button" class="btn btn-primary" id="addProductBtn">
                            <span class="material-symbols-outlined">add</span>
                            Add Product
                        </button>
                    </div>
                </div>
            </div>

            <div class="totals-section">
                <div class="total-row">
                    <span>Subtotal:</span>
                    <span id="displaySum">â‚¹0.00</span>
                </div>
                <div class="total-row">
                    <span>Tax:</span>
                    <span id="displayTax">â‚¹0.00</span>
                </div>
                <div class="total-row">
                    <span>Total Amount:</span>
                    <span id="displayTotal">â‚¹0.00</span>
                </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
                <button class="action-button" type="submit" id="submitButton">
                    <span class="material-symbols-outlined">receipt_long</span>
                    Generate Invoice
                </button>
            </div>
        </div>
    </div>

    <!-- Selected Products -->
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="card-title">
                <span class="material-symbols-outlined">list</span>
                Selected Products
            </h5>
        </div>
        <div class="card-body">
            <div class="table-container">
                <table class="table selected-products-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="selectedProductsTableBody">
                        <tr id="noProductsMessage">
                            <td colspan="5" class="text-center py-4 text-muted">No products added yet</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Hidden inputs for product quantities and IDs -->
    <input type="hidden" name="quantities" id="quantities">
    <input type="hidden" name="productIds" id="productIds">
</form>

<div id="billGeneratedSection" class="card mt-4" style="display: none;">
    <div class="card-body text-center">
        <h5 class="text-success mb-3">
            <span class="material-symbols-outlined">check_circle</span>
            Invoice Generated Successfully!
        </h5>
        <a id="pdfLink" href="#" target="_blank" class="btn btn-primary">
            <span class="material-symbols-outlined">download</span>
            Download PDF
        </a>
    </div>
</div>

<!-- Invoice Section-specific JavaScript -->
<script>
    // Invoice specific variables
    let invoiceSelectedProducts = {};
    let invoiceProductsData = [];
    let isViewMode = false;
    let viewedInvoiceId = null;

    // Initialize invoice when the section is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Check if we're on the invoice section
        if (document.getElementById('billingForm')) {
            initializeInvoice();
        }
    });

    // Force initialization when this section is loaded (for Thymeleaf)
    setTimeout(() => {
        if (document.getElementById('billingForm') && !window.invoiceInitialized) {
            initializeInvoice();
        }
    }, 100);

    function initializeInvoice() {
        console.log('Initializing Invoice section...');
        window.invoiceInitialized = true;
        
        // Check if we're in view mode (coming from dashboard or history)
        const viewInvoiceId = sessionStorage.getItem('viewInvoiceId');
        console.log('invoice id format',viewInvoiceId );
        if (viewInvoiceId) {
            console.log('Loading invoice for viewing:', viewInvoiceId);
            isViewMode = true;
            viewedInvoiceId = viewInvoiceId;
            loadInvoiceDetails(viewInvoiceId);
            // Clear the stored ID so we don't load it again on refresh
            sessionStorage.removeItem('viewInvoiceId');
        } else {
            // Normal mode - load next invoice ID
            loadNextInvoiceId();
        }

        // Initialize other components
        initializeGstFields();
        initializeBarcodeScanner();
        initializeProductSearch();
        initializeFormSubmission();
        initializeCustomerPhoneAutoFill();
        initializeEventListeners();

        // Only reset form if not in view mode
        if (!isViewMode) {
            resetInvoiceForm();
        }
    }

    function loadNextInvoiceId() {
        $.ajax({
            url: '/next-invoice-id',
            type: 'GET',
            success: function(response) {
                const invoiceIdElement = document.getElementById('invoiceId');
                if (invoiceIdElement) {
                	const today = new Date();
                	const yyyyMMdd = today.toISOString().split('T')[0].replace(/-/g, '');
                	invoiceIdElement.value = `INV-${response}-${yyyyMMdd}`;

                    //invoiceIdElement.value = "INV-" + response;
                }
                const viewedInvoiceBadge = document.getElementById('viewedInvoiceId');
                if (viewedInvoiceBadge && !isViewMode) {
                    viewedInvoiceBadge.textContent = invoiceIdElement.value;
                }
            },
            error: function(error) {
                console.error('Error loading next invoice ID:', error);
            }
        });
    }

    function loadInvoiceDetails(invoiceId) {
        console.log('Loading invoice details for:', invoiceId);
        
        // Show loading state
        document.getElementById('selectedProductsTableBody').innerHTML = 
            '<tr><td colspan="5" class="text-center py-4 text-muted">Loading invoice details...</td></tr>';

        $.ajax({
            url: `/api/invoices/${invoiceId}`,
            
            method: 'GET',
            success: function (invoice) {
                if (invoice) {
                    console.log("Invoice Data loaded:", invoice);

                    // Update page title to show we're viewing
                    document.querySelector('.page-title').textContent = 'View Invoice';
                    document.querySelector('.page-subtitle').textContent = 'Viewing invoice details';

                    // Populate form fields
                     document.getElementById('invoiceId').value = invoice.invoiceNumber || invoice.id; // Use invoiceNumber if available
                     document.getElementById('viewedInvoiceId').textContent = invoice.invoiceNumber || invoice.id; // Badge in view mode
                    document.getElementById('customerPhone').value = invoice.customerPhoneNumber || '';
                    document.getElementById('customerName').value = invoice.customerName || '';
                    document.getElementById('customerGstin').value = invoice.customerGstin || '';
                    document.getElementById('orderType').value = invoice.orderType || 'sales';
                    
                    // Set tax percentage if available
                    if (invoice.taxPercentage) {
                        document.getElementById('tax').value = invoice.taxPercentage;
                    }
                    
                    // Populate B2B fields if they exist
                    if (invoice.transportMode) {
                        document.getElementById('transportMode').value = invoice.transportMode;
                    }
                    if (invoice.vehicleNumber) {
                        document.getElementById('vehicleNumber').value = invoice.vehicleNumber;
                    }
                    if (invoice.reverseCharge) {
                        document.getElementById('reverseCharge').checked = invoice.reverseCharge;
                    }
                    if (invoice.supplyDate) {
                        document.getElementById('supplyDate').value = invoice.supplyDate;
                    }
                    if (invoice.dueDate) {
                        document.getElementById('dueDate').value = invoice.dueDate;
                    }

                    // Show B2B fields if GST is present
                    if (invoice.customerGstin) {
                        document.getElementById('b2bFields').style.display = 'block';
                    }

                    // Clear existing selected products
                    invoiceSelectedProducts = {};
                    
                    // Populate products table
                    if (invoice.items && invoice.items.length > 0) {
                        invoice.items.forEach((item, index) => {
                            const productId = item.productId || `view-${index}`;
                            invoiceSelectedProducts[productId] = {
                                id: productId,
                                name: item.productName,
                                price: item.price || 0,
                                quantity: item.quantity || 1
                            };
                        });
                        
                        updateProductTable();
                        
                        // Update totals from the invoice data
                        const subtotal = invoice.totalAmount - (invoice.taxAmount || 0);
                        document.getElementById('sum').value = subtotal.toFixed(2);
                        document.getElementById('taxAmount').value = (invoice.taxAmount || 0).toFixed(2);
                        document.getElementById('totalPrice').value = (invoice.totalAmount || 0).toFixed(2);
                        
                        // Update display totals
                        document.getElementById('displaySum').textContent = 'â‚¹' + subtotal.toFixed(2);
                        document.getElementById('displayTax').textContent = 'â‚¹' + (invoice.taxAmount || 0).toFixed(2);
                        document.getElementById('displayTotal').textContent = 'â‚¹' + (invoice.totalAmount || 0).toFixed(2);
                    } else {
                        console.error('No items to display');
                        updateProductTable();
                    }

                    // Enable view mode
                    enableViewMode(invoiceId);
                    
                } else {
                    console.error('Invoice data is missing');
                    alert('Error: Could not load invoice details');
                    // Fall back to normal mode
                    isViewMode = false;
                    loadNextInvoiceId();
                    resetInvoiceForm();
                }
            },
            error: function (xhr, status, error) {
                console.error('Failed to fetch invoice data:', error);
                alert('Error loading invoice details. Please try again.');
                // Fall back to normal mode
                isViewMode = false;
                loadNextInvoiceId();
                resetInvoiceForm();
            }
        });
    }

    function enableViewMode(invoiceId) {
        isViewMode = true;
        viewedInvoiceId = invoiceId;
        
        // Show view mode alert
        const viewModeAlert = document.getElementById('viewModeAlert');
        document.getElementById('viewedInvoiceId').textContent = invoiceId;
        viewModeAlert.style.display = 'block';
        
        // Add view-mode class to form
        document.getElementById('billingForm').classList.add('view-mode');
        
        // Update submit button text
        document.getElementById('submitButton').innerHTML = `
            <span class="material-symbols-outlined">visibility</span>
            Viewing Invoice
        `;
        
        // Disable form submission in view mode
        document.getElementById('billingForm').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('This invoice is in view mode. Click "Edit Invoice" to make changes.');
        });
        
        console.log('View mode enabled for invoice:', invoiceId);
    }

    function exitViewMode() {
        isViewMode = false;
        viewedInvoiceId = null;
        
        // Hide view mode alert
        document.getElementById('viewModeAlert').style.display = 'none';
        
        // Remove view-mode class from form
        document.getElementById('billingForm').classList.remove('view-mode');
        
        // Re-enable form submission
        document.getElementById('billingForm').removeEventListener('submit', arguments.callee);
        initializeFormSubmission();
        
        // Update submit button text
        document.getElementById('submitButton').innerHTML = `
            <span class="material-symbols-outlined">receipt_long</span>
            Generate Invoice
        `;
        
        // Reset page title
        document.querySelector('.page-title').textContent = 'Create New Invoice';
        document.querySelector('.page-subtitle').textContent = 'Generate professional invoices for your customers';
        
        console.log('Exited view mode');
    }

    function initializeGstFields() {
    	console.log("gstdebugging");
        const gstField = document.getElementById("customerGstin");
        const b2bFields = document.getElementById("b2bFields");
        
        if (gstField && b2bFields) {
            const gstRegex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/i;
            
            function toggleB2BFields() {
                const gstValue = gstField.value.trim();
                if (gstRegex.test(gstValue)) {
                    b2bFields.style.display = "block";
                } else {
                    b2bFields.style.display = "none";
                }
            }

            gstField.addEventListener("input", toggleB2BFields);
            // Initial check
            toggleB2BFields();
        }
    }

    function initializeBarcodeScanner() {
        const barcodeInput = document.getElementById('barcodeInput');
        const startScannerBtn = document.getElementById('startScannerBtn');
        const stopScannerBtn = document.getElementById('stopScannerBtn');
        const scannerStatus = document.getElementById('scannerStatus');
        
        let scannerActive = false;
        let barcodeBuffer = '';
        let barcodeTimeout;
        
        function startScanner() {
            scannerActive = true;
            barcodeBuffer = '';
            barcodeInput.value = '';
            barcodeInput.focus();
            
            startScannerBtn.disabled = true;
            stopScannerBtn.disabled = false;
            scannerStatus.textContent = 'Scanner active - ready to scan';
            scannerStatus.className = 'scanner-status';
            
            console.log('Barcode scanner started');
        }
        
        function stopScanner() {
            scannerActive = false;
            
            startScannerBtn.disabled = false;
            stopScannerBtn.disabled = true;
            scannerStatus.textContent = 'Scanner not active';
            scannerStatus.className = 'scanner-status';
            
            console.log('Barcode scanner stopped');
        }
        
        barcodeInput.addEventListener('keydown', function(e) {
            if (!scannerActive) return;
            
            clearTimeout(barcodeTimeout);
            
            if (e.key === 'Enter') {
                e.preventDefault();
                
                if (barcodeBuffer.length > 0) {
                    processBarcode(barcodeBuffer);
                    barcodeBuffer = '';
                    barcodeInput.value = '';
                }
                return;
            }
            
            if (e.key.length === 1) {
                barcodeBuffer += e.key;
                barcodeInput.value = '*'.repeat(barcodeBuffer.length);
            }
            
            barcodeTimeout = setTimeout(function() {
                if (barcodeBuffer.length > 0) {
                    processBarcode(barcodeBuffer);
                    barcodeBuffer = '';
                    barcodeInput.value = '';
                }
            }, 500);
        });
        
        startScannerBtn.addEventListener('click', startScanner);
        stopScannerBtn.addEventListener('click', stopScanner);
        
        function processBarcode(barcode) {
            console.log('Processing barcode:', barcode);
            
            fetch(`/billing/find-by-barcode?barcode=${encodeURIComponent(barcode)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Product not found');
                    }
                    return response.json();
                })
                .then(product => {
                    const productId = product.id || barcode;
                    addOrUpdateProduct(product, productId);
                    
                    scannerStatus.textContent = `Product found: ${product.name}`;
                    setTimeout(() => {
                        if (scannerActive) {
                            scannerStatus.textContent = 'Scanner active - ready to scan';
                            barcodeInput.value = '';
                            barcodeInput.focus();
                        }
                    }, 2000);
                })
                .catch(error => {
                    console.error('Error fetching product:', error);
                    scannerStatus.textContent = `Error: ${error.message}`;
                    
                    setTimeout(() => {
                        if (scannerActive) {
                            scannerStatus.textContent = 'Scanner active - ready to scan';
                            barcodeInput.value = '';
                            barcodeInput.focus();
                        }
                    }, 2000);
                });
        }

        function addOrUpdateProduct(product, productId) {
            const quantity = parseInt(document.getElementById("productQuantity").value) || 1;
            
            if (invoiceSelectedProducts[productId]) {
                invoiceSelectedProducts[productId].quantity += quantity;
            } else {
                invoiceSelectedProducts[productId] = {
                    id: productId,
                    name: product.name,
                    price: product.price,
                    quantity: quantity
                };
            }
            
            updateProductTable();
            updateInvoiceTotals();
        }
        
        // Manual barcode entry (without scanner mode)
        barcodeInput.addEventListener('keydown', function(e) {
            if (!scannerActive && e.key === 'Enter') {
                e.preventDefault();
                const barcode = barcodeInput.value.trim();
                if (barcode) {
                    processBarcode(barcode);
                    barcodeInput.value = '';
                }
            }
        });
    }

    function initializeProductSearch() {
        const productSearchInput = document.getElementById("product-search");
        const idProductInput = document.getElementById("id_product");
        const suggestionBox = document.getElementById("suggestion-box");
        const addProductBtn = document.getElementById("addProductBtn");

        productSearchInput.addEventListener("input", function () {
            const term = productSearchInput.value;

            if (term.length < 2) {
                clearSuggestions();
                return;
            }
            
            fetch(`/billing/search?term=${encodeURIComponent(term)}`)
                .then(response => response.json())
                .then(data => {
                    invoiceProductsData = data;
                    clearSuggestions();
                    if (data.length) {
                        showSuggestions(data);
                    }
                })
                .catch(error => {
                    console.error('Error searching products:', error);
                    clearSuggestions();
                });
        });

        document.addEventListener("click", function (event) {
            if (!productSearchInput.contains(event.target) && !suggestionBox.contains(event.target)) {
                clearSuggestions();
            }
        });

        // Add product button click handler
        addProductBtn.addEventListener('click', function() {
            const productId = idProductInput.value;
            const productName = productSearchInput.value;
            
            if (!productId || !productName) {
                alert('Please select a product from the suggestions first');
                return;
            }

            const selectedProduct = invoiceProductsData.find(product => product.id == productId);
            if (selectedProduct) {
                addProductToSelected(selectedProduct);
                // Clear the search input
                productSearchInput.value = '';
                idProductInput.value = '';
                clearSuggestions();
            }
        });

        function clearSuggestions() {
            suggestionBox.innerHTML = '';
            suggestionBox.style.display = 'none';
        }

        function showSuggestions(data) {
            suggestionBox.innerHTML = "";

            data.forEach(item => {
                const suggestionItem = document.createElement("div");
                suggestionItem.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="flex-grow: 1;">${item.name}</span>
                        <span style="color: #888; font-size: 12px;">Price: â‚¹${item.price}</span>
                    </div>
                `;
                suggestionItem.className = 'suggestion-item';
                suggestionItem.addEventListener("click", function () {
                    productSearchInput.value = item.name;
                    idProductInput.value = item.id;
                    clearSuggestions();
                    
                    // Auto-fill the price in subtotal
                    const quantity = parseInt(document.getElementById("productQuantity").value) || 1;
                    const subtotal = item.price * quantity;
                    document.getElementById("sum").value = subtotal.toFixed(2);
                    updateInvoiceTotals();
                });

                suggestionBox.appendChild(suggestionItem);
            });

            suggestionBox.style.display = 'block';
        }

        function addProductToSelected(product) {
            const quantity = parseInt(document.getElementById("productQuantity").value) || 1;

            if (invoiceSelectedProducts[product.id]) {
                invoiceSelectedProducts[product.id].quantity += quantity;
            } else {
                invoiceSelectedProducts[product.id] = {
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: quantity
                };
            }

            updateProductTable();
            updateInvoiceTotals();
            
            // Reset quantity to 1 after adding
            document.getElementById("productQuantity").value = 1;
            document.getElementById("sum").value = "0.00";
        }
    }

    function initializeFormSubmission() {
        const billingForm = document.getElementById('billingForm');
        
        billingForm.addEventListener('submit', function (event) {
            event.preventDefault();

            // Check if any products are selected
            if (Object.keys(invoiceSelectedProducts).length === 0) {
                alert('Please add at least one product to the invoice');
                return;
            }

            const quantities = [];
            const productIds = [];

            for (const productId in invoiceSelectedProducts) {
                const product = invoiceSelectedProducts[productId];
                quantities.push(product.quantity);
                productIds.push(product.id);
            }

            const customerName = document.getElementById('customerName').value;
            const customerGstin = document.getElementById('customerGstin').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const orderType = document.getElementById('orderType').value;
            const sum = document.getElementById('totalPrice').value;
            const transportMode = document.getElementById('transportMode').value;
            const vehicleNumber = document.getElementById('vehicleNumber').value;
            const reverseCharge = document.getElementById('reverseCharge').checked;
            const supplyDate = document.getElementById('supplyDate').value;
            const dueDate = document.getElementById('dueDate').value;
            const taxPercentage = document.getElementById('tax').value;

            console.log('Submitting invoice data:', {
                quantities: quantities,
                productIds: productIds,
                customerName: customerName,
                customerPhone: customerPhone,
                orderType: orderType,
                sum: sum,
                customerGstin: customerGstin,
                transportMode: transportMode,
                vehicleNumber: vehicleNumber,
                reverseCharge: reverseCharge,
                supplyDate: supplyDate,
                dueDate: dueDate,
                taxPercentage: taxPercentage
            });

            $.ajax({
                url: '/billing',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                	 invoiceNumber: document.getElementById('invoiceId').value,
                    quantities: quantities,
                    productIds: productIds,
                    customerName: customerName,
                    customerPhone: customerPhone,
                    orderType: orderType,
                    sum: sum,
                    customerGstin: customerGstin,
                    transportMode: transportMode,
                    vehicleNumber: vehicleNumber,
                    reverseCharge: reverseCharge,
                    supplyDate: supplyDate,
                    dueDate: dueDate,
                    taxPercentage: taxPercentage
                }),
                success: function (response) {
                    console.log('Invoice generated successfully:', response);
                    if (response.pdfUrl) {
                        window.location.href = response.pdfUrl;
                    } else {
                        alert('Invoice generated successfully!');
                        resetInvoiceForm();
                    }
                },
                error: function (error) {
                    console.error('Error generating invoice:', error);
                    alert("Error generating invoice: " + (error.responseText || 'Unknown error'));
                }
            });
        });
    }

    function initializeCustomerPhoneAutoFill() {
        const customerPhoneInput = document.getElementById('customerPhone');
        
        customerPhoneInput.addEventListener('input', function() {
            var phone = this.value;
            if (phone.length === 10) {
                fetch('/get-customer-details?phone=' + phone)
                    .then(response => response.json())
                    .then(data => {
                        if (data.name) {
                        	console.log('data++++',data);
                            document.getElementById('customerName').value = data.name;
                        } else {
                            document.getElementById('customerName').value = '';
                        }
                        if(data.gstNo){
                        	document.getElementById('customerGstin').value = data.gstNo;
                        	  
                            document.getElementById('b2bFields').style.display = 'block';
                              
                        }else{
                        	 document.getElementById('customerGstin').value = '';
                        }
                       
                    })
                    .catch(error => console.error('Error fetching customer name:', error));
            }
        });
      
    }

    function initializeEventListeners() {
        // Tax change listener
        document.getElementById('tax').addEventListener('change', updateInvoiceTotals);
        
        // Quantity change listener
        document.getElementById('productQuantity').addEventListener('change', function() {
            const productId = document.getElementById('id_product').value;
            if (productId) {
                const selectedProduct = invoiceProductsData.find(product => product.id == productId);
                if (selectedProduct) {
                    const quantity = parseInt(this.value) || 1;
                    const subtotal = selectedProduct.price * quantity;
                    document.getElementById('sum').value = subtotal.toFixed(2);
                    updateInvoiceTotals();
                }
            }
        });
    }

    function updateProductTable() {
        const tableBody = document.getElementById('selectedProductsTableBody');
        const noProductsMessage = document.getElementById('noProductsMessage');
        tableBody.innerHTML = '';

        let totalSum = 0;

        if (Object.keys(invoiceSelectedProducts).length === 0) {
            if (!noProductsMessage) {
                tableBody.innerHTML = '<tr id="noProductsMessage"><td colspan="5" class="text-center py-4 text-muted">No products added yet</td></tr>';
            } else {
                tableBody.appendChild(noProductsMessage);
            }
            return;
        }

        // Remove no products message if it exists
        if (noProductsMessage) {
            noProductsMessage.remove();
        }

        for (const productId in invoiceSelectedProducts) {
            const product = invoiceSelectedProducts[productId];
            const productTotal = product.price * product.quantity;
            totalSum += productTotal;

            const newRow = document.createElement('tr');
            newRow.setAttribute('data-product-id', productId);
            newRow.innerHTML = `
                <td>${product.name}</td>
                <td class="product-quantity">${product.quantity}</td>
                <td>â‚¹${product.price.toFixed(2)}</td>
                <td class="product-total">â‚¹${productTotal.toFixed(2)}</td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm remove-product-btn">
                        <span class="material-symbols-outlined" style="font-size: 16px;">delete</span>
                    </button>
                </td>
            `;
            tableBody.appendChild(newRow);
        }

        // Add event listeners to remove buttons
        document.querySelectorAll('.remove-product-btn').forEach(button => {
            button.addEventListener('click', function() {
                const row = this.closest('tr');
                const productId = row.getAttribute('data-product-id');
                
                if (productId && confirm('Are you sure you want to remove this product?')) {
                    delete invoiceSelectedProducts[productId];
                    updateProductTable();
                    updateInvoiceTotals();
                }
            });
        });

        document.getElementById('sum').value = totalSum.toFixed(2);
        updateInvoiceTotals();
    }

    function updateInvoiceTotals() {
        const taxPercentage = parseFloat(document.getElementById('tax').value) || 0;
        const sum = parseFloat(document.getElementById('sum').value) || 0;

        const taxAmount = (sum * taxPercentage) / 100;
        const totalPrice = sum + taxAmount;

        document.getElementById('taxAmount').value = taxAmount.toFixed(2);
        document.getElementById('totalPrice').value = totalPrice.toFixed(2);
        
        // Update display totals
        document.getElementById('displaySum').textContent = 'â‚¹' + sum.toFixed(2);
        document.getElementById('displayTax').textContent = 'â‚¹' + taxAmount.toFixed(2);
        document.getElementById('displayTotal').textContent = 'â‚¹' + totalPrice.toFixed(2);
    }

    function resetInvoiceForm() {
        // Clear selected products
        invoiceSelectedProducts = {};
        updateProductTable();
        
        // Reset form fields
        document.getElementById('customerName').value = '';
        document.getElementById('customerPhone').value = '';
        document.getElementById('customerGstin').value = '';
        document.getElementById('transportMode').value = '';
        document.getElementById('vehicleNumber').value = '';
        document.getElementById('reverseCharge').checked = false;
        document.getElementById('supplyDate').value = '';
        document.getElementById('dueDate').value = '';
        document.getElementById('productQuantity').value = 1;
        document.getElementById('product-search').value = '';
        document.getElementById('id_product').value = '';
        
        // Reset totals
        document.getElementById('sum').value = '0.00';
        document.getElementById('taxAmount').value = '0.00';
        document.getElementById('totalPrice').value = '0.00';
        updateInvoiceTotals();
        
        // Hide B2B fields
        document.getElementById('b2bFields').style.display = 'none';
        
        // Load new invoice ID
        loadNextInvoiceId();
    }
</script>